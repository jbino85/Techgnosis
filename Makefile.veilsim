# VeilSim Studio ‚Äî OSOVM Simulation Ecosystem Build System
# Crown Architect: B√≠n√≤ √àL Gu√† ·ªåm·ªç K·ªçÃÅd√† √Ä·π£·∫π

.PHONY: help all clean build test veilsim julia rust backend frontend docker deploy

# ============================================================================
# BUILD CONFIGURATION
# ============================================================================

JULIA := julia
CARGO := cargo
PYTHON := python3
NPM := npm
DOCKER := docker

VEILSIM_VERSION := 1.0.0
GENESIS_TIME := 2025-11-11T11:11:11.11Z

# Directories
SRC_DIR := src
FFI_DIR := ffi
EXAMPLES_DIR := examples
BACKEND_DIR := backend
FRONTEND_DIR := frontend

# Output
BUILD_DIR := build
DIST_DIR := dist

# ============================================================================
# HELP
# ============================================================================

help:
	@echo "ü§çüóø‚öñÔ∏èüïäÔ∏èüåÑ VeilSim Studio ‚Äî OSOVM Build System"
	@echo ""
	@echo "Usage: make [target]"
	@echo ""
	@echo "Core Targets:"
	@echo "  all                  Build entire VeilSim ecosystem"
	@echo "  veilsim              Build Julia + Rust + .tech compiler"
	@echo "  julia                Build Julia veilsim_engine module"
	@echo "  rust                 Build Rust FFI bridge (C ABI)"
	@echo "  backend              Build FastAPI backend"
	@echo "  frontend             Build React frontend"
	@echo "  test                 Run all tests"
	@echo "  docker               Build Docker image"
	@echo "  deploy               Deploy to Kubernetes"
	@echo "  clean                Remove build artifacts"
	@echo ""
	@echo "Utilities:"
	@echo "  check-env            Verify build environment"
	@echo "  genesis-init         Initialize Genesis handshake"
	@echo "  veil-index           Generate 777 Veil index"
	@echo "  docs                 Generate documentation"
	@echo ""

# ============================================================================
# ENVIRONMENT CHECK
# ============================================================================

check-env:
	@echo "Checking build environment..."
	@command -v $(JULIA) >/dev/null 2>&1 || (echo "‚ùå Julia not found" && exit 1)
	@command -v $(CARGO) >/dev/null 2>&1 || (echo "‚ùå Cargo not found" && exit 1)
	@command -v $(PYTHON) >/dev/null 2>&1 || (echo "‚ùå Python not found" && exit 1)
	@command -v $(NPM) >/dev/null 2>&1 || (echo "‚ùå NPM not found" && exit 1)
	@echo "‚úÖ All dependencies found"

# ============================================================================
# JULIA BUILD
# ============================================================================

julia: check-env
	@echo "üì¶ Building Julia VeilSim Engine..."
	@mkdir -p $(BUILD_DIR)
	$(JULIA) --project=$(SRC_DIR) -e "using Pkg; Pkg.instantiate()"
	$(JULIA) --project=$(SRC_DIR) -e "include(\"$(SRC_DIR)/veilsim_engine.jl\")"
	@echo "‚úÖ Julia build complete"

julia-test:
	@echo "üß™ Running Julia tests..."
	$(JULIA) --project=$(SRC_DIR) -e "using Pkg; Pkg.test()"

# ============================================================================
# RUST BUILD
# ============================================================================

rust: check-env
	@echo "ü¶Ä Building Rust FFI Bridge..."
	cd $(FFI_DIR) && $(CARGO) build --release
	@mkdir -p $(BUILD_DIR)/lib
	@cp $(FFI_DIR)/target/release/libveilsim_ffi.{so,dylib,dll} $(BUILD_DIR)/lib/ 2>/dev/null || true
	@echo "‚úÖ Rust build complete"

rust-test:
	@echo "üß™ Running Rust tests..."
	cd $(FFI_DIR) && $(CARGO) test --release

# ============================================================================
# BACKEND BUILD
# ============================================================================

backend: check-env
	@echo "üêç Setting up FastAPI Backend..."
	cd $(BACKEND_DIR) && $(PYTHON) -m pip install -r requirements.txt
	@echo "‚úÖ Backend dependencies installed"

backend-test:
	@echo "üß™ Running backend tests..."
	cd $(BACKEND_DIR) && $(PYTHON) -m pytest tests/

backend-run:
	@echo "‚ñ∂Ô∏è  Starting backend server..."
	cd $(BACKEND_DIR) && uvicorn api.main:app --reload --host 0.0.0.0 --port 8000

# ============================================================================
# FRONTEND BUILD
# ============================================================================

frontend: check-env
	@echo "üì± Building React Frontend..."
	cd $(FRONTEND_DIR) && $(NPM) install
	cd $(FRONTEND_DIR) && $(NPM) run build
	@echo "‚úÖ Frontend build complete"

frontend-dev:
	@echo "üé® Starting frontend dev server..."
	cd $(FRONTEND_DIR) && $(NPM) start

frontend-test:
	@echo "üß™ Running frontend tests..."
	cd $(FRONTEND_DIR) && $(NPM) test

# ============================================================================
# CORE VEILSIM BUILD
# ============================================================================

veilsim: julia rust
	@echo "ü§ç VeilSim Core Build"
	@mkdir -p $(DIST_DIR)
	@echo "‚úÖ VeilSim core built successfully"

# ============================================================================
# COMPILATION & CODEGEN
# ============================================================================

compile-tech:
	@echo "üî® Compiling .tech specifications..."
	$(JULIA) --project=$(SRC_DIR) -e "include(\"$(SRC_DIR)/techgnos_compiler.jl\")"
	@echo "‚úÖ .tech compilation complete"

index-veils:
	@echo "üìö Generating 777 Veil Index..."
	$(JULIA) --project=$(SRC_DIR) -e "include(\"$(SRC_DIR)/veil_index.jl\")"
	@cp $(SRC_DIR)/veil_index.json $(DIST_DIR)/
	@echo "‚úÖ Veil index generated"

# ============================================================================
# TESTING
# ============================================================================

test: julia-test rust-test backend-test frontend-test
	@echo "‚úÖ All tests passed"

test-integration:
	@echo "üîó Running integration tests..."
	$(PYTHON) tests/integration_test.py
	@echo "‚úÖ Integration tests passed"

# ============================================================================
# DOCKER BUILD & DEPLOY
# ============================================================================

docker: veilsim backend frontend
	@echo "üê≥ Building Docker image..."
	$(DOCKER) build -t veilsim-studio:$(VEILSIM_VERSION) .
	$(DOCKER) tag veilsim-studio:$(VEILSIM_VERSION) veilsim-studio:latest
	@echo "‚úÖ Docker image built: veilsim-studio:$(VEILSIM_VERSION)"

docker-run:
	@echo "‚ñ∂Ô∏è  Running Docker container..."
	$(DOCKER) run -it -p 3000:3000 -p 8000:8000 veilsim-studio:latest

docker-push:
	@echo "üì§ Pushing Docker image..."
	$(DOCKER) push veilsim-studio:$(VEILSIM_VERSION)
	$(DOCKER) push veilsim-studio:latest

# ============================================================================
# KUBERNETES DEPLOYMENT
# ============================================================================

k8s-create-ns:
	@echo "üéØ Creating Kubernetes namespace..."
	kubectl create namespace veilsim || true

k8s-deploy: docker-push k8s-create-ns
	@echo "üöÄ Deploying to Kubernetes..."
	kubectl apply -f kubernetes/veilsim_deployment.yaml
	kubectl apply -f kubernetes/veilsim_service.yaml
	kubectl apply -f kubernetes/veilsim_configmap.yaml
	@echo "‚úÖ Deployed to Kubernetes"

k8s-status:
	@echo "üìä Kubernetes deployment status..."
	kubectl get deployments -n veilsim
	kubectl get pods -n veilsim
	kubectl get services -n veilsim

k8s-logs:
	@echo "üìã Kubernetes logs..."
	kubectl logs -n veilsim -l app=veilsim-studio -f

k8s-delete:
	@echo "üóëÔ∏è  Deleting Kubernetes deployment..."
	kubectl delete namespace veilsim

# ============================================================================
# GENESIS INITIALIZATION
# ============================================================================

genesis-init:
	@echo "üåÖ Initializing Genesis Handshake..."
	$(JULIA) whisper_ase_v8.jl
	@echo "‚úÖ Genesis initialized at $(GENESIS_TIME)"

genesis-verify:
	@echo "üîê Verifying Genesis state..."
	$(JULIA) --project=$(SRC_DIR) -e "include(\"$(SRC_DIR)/oso_vm.jl\")"
	@echo "‚úÖ Genesis verification complete"

# ============================================================================
# DOCUMENTATION & ARTIFACTS
# ============================================================================

docs:
	@echo "üìñ Generating documentation..."
	mkdir -p $(DIST_DIR)/docs
	@cp VEILSIM_ECOSYSTEM.md $(DIST_DIR)/docs/
	@cp veilsim_architecture.tech $(DIST_DIR)/docs/
	@cp examples/*.tech $(DIST_DIR)/docs/examples/ || true
	@echo "‚úÖ Documentation generated"

artifacts:
	@echo "üì¶ Creating distribution artifacts..."
	mkdir -p $(DIST_DIR)
	tar -czf $(DIST_DIR)/veilsim-$(VEILSIM_VERSION).tar.gz \
		$(SRC_DIR)/ $(FFI_DIR)/ $(EXAMPLES_DIR)/ \
		VEILSIM_ECOSYSTEM.md veilsim_architecture.tech
	@echo "‚úÖ Artifacts created: $(DIST_DIR)/veilsim-$(VEILSIM_VERSION).tar.gz"

# ============================================================================
# FULL BUILD & DEPLOYMENT
# ============================================================================

build: check-env veilsim backend frontend compile-tech index-veils test
	@echo ""
	@echo "üéâ VeilSim Full Build Complete!"
	@echo "   Version: $(VEILSIM_VERSION)"
	@echo "   Time: $(GENESIS_TIME)"
	@echo ""

deploy: docker k8s-deploy
	@echo ""
	@echo "üöÄ VeilSim Deployed!"
	@echo "   Frontend: http://localhost:3000"
	@echo "   API: http://localhost:8000"
	@echo "   K8s Dashboard: kubectl port-forward -n veilsim svc/veilsim-studio 3000:3000"
	@echo ""

all: build deploy docs artifacts
	@echo ""
	@echo "‚ú® VeilSim Studio Ready"
	@echo ""

# ============================================================================
# CLEANUP
# ============================================================================

clean:
	@echo "üßπ Cleaning build artifacts..."
	rm -rf $(BUILD_DIR) $(DIST_DIR)
	cd $(FFI_DIR) && $(CARGO) clean
	cd $(BACKEND_DIR) && find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	cd $(FRONTEND_DIR) && rm -rf node_modules build 2>/dev/null || true
	@echo "‚úÖ Clean complete"

distclean: clean
	@echo "üóëÔ∏è  Full clean (removing all generated files)..."
	rm -f $(SRC_DIR)/veil_index.json
	rm -f genesis_receipt_*.json
	@echo "‚úÖ Full clean complete"

# ============================================================================
# DEFAULT TARGET
# ============================================================================

.DEFAULT_GOAL := help
