SHELL := /bin/bash

# Paths
IMMUNE := immune
SHRINE := shrine
SHARED := shared
REC_OUT := $(IMMUNE)/receipts/out

# Env
include .env
export

.PHONY: deps patrol anchor submit shrine-bootstrap sabbath clean

deps:
	@echo "Installing deps..."
	@pip install -r requirements.txt || true
	@cd $(SHRINE) && npm i

patrol:
	@echo "Running veils under sandbox limits..."
	@python3 $(IMMUNE)/sandbox/run_with_limits.py python3 $(IMMUNE)/masks/veil1_ifa_bones.py | tee /dev/stderr >/dev/null
	@python3 $(IMMUNE)/sandbox/run_with_limits.py python3 $(IMMUNE)/masks/veil4_temple_codes.py | tee /dev/stderr >/dev/null
	@python3 $(IMMUNE)/sandbox/run_with_limits.py python3 $(IMMUNE)/masks/veil6_chaos_fractals.py | tee /dev/stderr >/dev/null
	@echo "Receipts â†’ $(REC_OUT)" && ls -1 $(REC_OUT) || true

anchor:
	@echo "Anchoring recent receipts to Arweave + OTS..."
	@for r in $(REC_OUT)/*.json; do \
		[ -f "$$r" ] || continue; \
		node $(SHRINE)/scripts/arweave_anchor.js "$$r" | tee /dev/stderr; \
		AR_TX=$$(jq -r '.arweave_tx' <<<"$$(cat $$r)"); \
		if [ "$$AR_TX" != "null" ]; then \
			bash $(SHRINE)/scripts/ots.sh "$$AR_TX" | tee /dev/stderr; \
		fi; \
	done

submit:
	@echo "Submitting anchored receipts on-chain..."
	@REC=$$(ls -t $(REC_OUT)/*.json | head -n1); \
	node $(SHRINE)/scripts/submit_onchain_receipt.js $$PKG_ID $$WSET_ID $$LEDGER_ID $$REG_ID $$STATS_ID $$REC

shrine-bootstrap:
	@echo "Publishing Move pkg and initializing objects..."
	@cd $(SHRINE) && ./scripts/bootstrap.sh

sabbath:
	@echo "Weekly Sabbath seal routine..."
	@node $(SHRINE)/scripts/listen_receipts.js &
	@echo "Run ops/sabbath_checklist.md manually to seal the week."

clean:
	@rm -rf $(REC_OUT)/*.json
